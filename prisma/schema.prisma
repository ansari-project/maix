generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id           String               @id @default(cuid())
  name         String
  slug         String               @unique
  mission      String?
  description  String?
  url          String?
  aiEngagement String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  members      OrganizationMember[]
  products     Product[]
  projects     Project[]

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  role           OrgRole
  joinedAt       DateTime     @default(now())
  organizationId String
  userId         String
  invitationId   String?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
  @@index([role])
  @@map("organization_members")
}

model ProductMember {
  id           String      @id @default(cuid())
  role         UnifiedRole @default(MEMBER)
  joinedAt     DateTime    @default(now())
  productId    String
  userId       String
  invitationId String?
  product      Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([userId])
  @@index([role])
  @@map("product_members")
}

model ProjectMember {
  id           String      @id @default(cuid())
  role         UnifiedRole @default(MEMBER)
  joinedAt     DateTime    @default(now())
  projectId    String
  userId       String
  invitationId String?
  project      Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
  @@index([role])
  @@map("project_members")
}

model User {
  id                      String                  @id @default(cuid())
  email                   String                  @unique
  username                String                  @unique
  name                    String?
  image                   String?
  password                String?
  specialty               Specialty?
  experienceLevel         ExperienceLevel?
  bio                     String?
  linkedinUrl             String?
  githubUrl               String?
  portfolioUrl            String?
  skills                  String[]
  availability            String?
  timezone                String?
  isActive                Boolean                 @default(true)
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  lastDigestSentAt        DateTime?
  applications            Application[]
  comments                Comment[]
  messages                Message[]
  monitors                Monitor[]
  notificationPreference  NotificationPreference?
  notifications           Notification[]
  organizationMemberships OrganizationMember[]
  personalAccessTokens    PersonalAccessToken[]
  posts                   Post[]
  productMemberships      ProductMember[]
  products                Product[]
  projectMemberships      ProjectMember[]
  projects                Project[]
  todosAssigned           Todo[]                  @relation("TodosAssigned")
  todosCreated            Todo[]                  @relation("TodosCreated")

  @@index([skills], type: Gin)
  @@map("users")
}

model Project {
  id                   String          @id @default(cuid())
  name                 String
  goal                 String
  description          String
  contactEmail         String
  helpType             HelpType
  status               ProjectStatus   @default(AWAITING_VOLUNTEERS)
  targetCompletionDate DateTime?
  isActive             Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  ownerId              String?
  productId            String?
  organizationId       String?
  visibility           Visibility      @default(PUBLIC)
  applications         Application[]
  notifications        Notification[]
  discussionPost       Post?           @relation("ProjectDiscussionThread")
  updates              Post[]          @relation("ProjectUpdates")
  members              ProjectMember[]
  organization         Organization?   @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  owner                User?           @relation(fields: [ownerId], references: [id])
  product              Product?        @relation(fields: [productId], references: [id])
  todos                Todo[]

  @@index([isActive, createdAt])
  @@index([status])
  @@map("projects")
}

model Product {
  id             String          @id @default(cuid())
  name           String
  description    String
  url            String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  ownerId        String?
  organizationId String?
  visibility     Visibility      @default(PUBLIC)
  discussionPost Post?           @relation("ProductDiscussionThread")
  updates        Post[]          @relation("ProductUpdates")
  members        ProductMember[]
  organization   Organization?   @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  owner          User?           @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  projects       Project[]

  @@map("products")
}

model Application {
  id          String            @id @default(cuid())
  message     String
  status      ApplicationStatus @default(PENDING)
  appliedAt   DateTime          @default(now())
  respondedAt DateTime?
  userId      String
  projectId   String
  project     Project           @relation(fields: [projectId], references: [id])
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("applications")
}

model Message {
  id          String   @id @default(cuid())
  content     String
  isRead      Boolean  @default(false)
  sentAt      DateTime @default(now())
  senderId    String
  recipientId String
  sender      User     @relation(fields: [senderId], references: [id])

  @@map("messages")
}

model PersonalAccessToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  name       String
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  expiresAt  DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("personal_access_tokens")
}

/// Structured content posts for questions, answers, and updates.
/// Implements the "Discussion Anchor Pattern" where PROJECT_DISCUSSION and PRODUCT_DISCUSSION
/// posts serve as anchors for comments on projects/products.
model Post {
  id                        String     @id @default(cuid())
  createdAt                 DateTime   @default(now())
  updatedAt                 DateTime   @updatedAt
  type                      PostType
  content                   String
  visibility                Visibility @default(PUBLIC)
  authorId                  String?
  projectId                 String?
  projectDiscussionThreadId String?   @unique
  productId                 String?
  productDiscussionThreadId String?   @unique
  parentId                  String?
  isResolved                Boolean   @default(false)
  bestAnswerId              String?   @unique
  todoId                    String?
  comments                  Comment[]
  author                    User?     @relation(fields: [authorId], references: [id])
  bestAnswer                Post?     @relation("BestAnswer", fields: [bestAnswerId], references: [id], onDelete: Restrict)
  questionForBestAnswer     Post?     @relation("BestAnswer")
  parent                    Post?     @relation("PostReplies", fields: [parentId], references: [id], onDelete: Restrict)
  replies                   Post[]    @relation("PostReplies")
  productDiscussionThread   Product?  @relation("ProductDiscussionThread", fields: [productDiscussionThreadId], references: [id], onDelete: Cascade)
  product                   Product?  @relation("ProductUpdates", fields: [productId], references: [id], onDelete: Cascade)
  projectDiscussionThread   Project?  @relation("ProjectDiscussionThread", fields: [projectDiscussionThreadId], references: [id], onDelete: Cascade)
  project                   Project?  @relation("ProjectUpdates", fields: [projectId], references: [id], onDelete: Cascade)
  todo                      Todo?     @relation("TodoPosts", fields: [todoId], references: [id])

  @@index([authorId])
  @@index([projectId])
  @@index([productId])
  @@index([parentId])
  @@index([projectDiscussionThreadId])
  @@index([productDiscussionThreadId])
  @@index([bestAnswerId])
  @@index([type, createdAt])
  @@index([todoId])
  @@map("posts")
}

model Comment {
  id        String    @id @default(cuid())
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  authorId  String?
  postId    String
  parentId  String?
  author    User?     @relation(fields: [authorId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Restrict)
  replies   Comment[] @relation("CommentReplies")
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

model Notification {
  id         String           @id @default(cuid())
  type       NotificationType
  title      String
  message    String
  entityType String
  entityId   String
  read       Boolean          @default(false)
  readAt     DateTime?
  createdAt  DateTime         @default(now())
  userId     String
  projectId  String?
  project    Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
  @@index([userId, createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id           String   @id @default(cuid())
  userId       String   @unique
  emailEnabled Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Monitor {
  id             String        @id @default(cuid())
  userId         String
  publicFigureId String
  topicId        String
  isActive       Boolean       @default(true)
  emailFrequency String        @default("daily")
  lastSearchedAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  emailReports   EmailReport[]
  publicFigure   PublicFigure  @relation(fields: [publicFigureId], references: [id])
  topic          Topic         @relation(fields: [topicId], references: [id])
  user           User          @relation(fields: [userId], references: [id])

  @@unique([userId, publicFigureId, topicId])
  @@index([userId])
  @@index([isActive, emailFrequency])
  @@map("monitors")
}

model PublicFigure {
  id        String    @id @default(cuid())
  name      String
  title     String?
  imageUrl  String?
  aliases   String[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  events    Event[]
  monitors  Monitor[]

  @@index([name])
  @@map("public_figures")
}

model Topic {
  id        String    @id @default(cuid())
  name      String
  keywords  String[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  events    Event[]
  monitors  Monitor[]

  @@index([name])
  @@map("topics")
}

model Event {
  id                String       @id @default(cuid())
  publicFigureId    String
  topicId           String
  title             String
  summary           String
  eventDate         DateTime
  eventType         String
  sentiment         String?
  stance            String?
  deduplicationHash String       @unique
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  articles          Article[]
  publicFigure      PublicFigure @relation(fields: [publicFigureId], references: [id])
  topic             Topic        @relation(fields: [topicId], references: [id])

  @@index([publicFigureId, topicId, eventDate])
  @@map("events")
}

model Article {
  id              String   @id @default(cuid())
  eventId         String
  headline        String
  sourceUrl       String   @unique
  sourceType      String
  sourcePublisher String
  publishedAt     DateTime
  fullText        String?
  keyQuotes       Json?
  contentHash     String   @unique
  createdAt       DateTime @default(now())
  event           Event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([sourceUrl])
  @@index([contentHash])
  @@map("articles")
}

model EmailReport {
  id         String   @id @default(cuid())
  monitorId  String
  eventIds   String[]
  eventCount Int
  sentAt     DateTime @default(now())
  status     String   @default("sent")
  monitor    Monitor  @relation(fields: [monitorId], references: [id])

  @@index([monitorId, sentAt])
  @@map("email_reports")
}

model Todo {
  id          String     @id @default(cuid())
  title       String     @db.VarChar(255)
  description String?
  status      TodoStatus @default(OPEN)
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  projectId   String
  creatorId   String
  assigneeId  String?
  posts       Post[]     @relation("TodoPosts")
  assignee    User?      @relation("TodosAssigned", fields: [assigneeId], references: [id])
  creator     User       @relation("TodosCreated", fields: [creatorId], references: [id])
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@index([assigneeId, status])
  @@map("todos")
}

enum Visibility {
  PUBLIC
  PRIVATE
  DRAFT
}

enum UnifiedRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum OrgRole {
  OWNER
  MEMBER
}

enum Specialty {
  AI
  FULL_STACK
  PROGRAM_MANAGER
}

enum ExperienceLevel {
  HOBBYIST
  INTERN
  NEW_GRAD
  SENIOR
}

enum HelpType {
  ADVICE
  PROTOTYPE
  MVP
  FULL_PRODUCT
}

enum ProjectStatus {
  AWAITING_VOLUNTEERS
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum PostType {
  QUESTION
  ANSWER
  PROJECT_UPDATE
  PRODUCT_UPDATE
  PROJECT_DISCUSSION
  PRODUCT_DISCUSSION
}

enum NotificationType {
  APPLICATION_NEW
  APPLICATION_ACCEPTED
  APPLICATION_REJECTED
  ANSWER_NEW
  NEW_QUESTION
  NEW_PROJECT
}

enum TodoStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
}
